---
import Card from "../ui/Card.astro";
import type { WordPressPost } from "../../types/wordpress";
import type { Language } from "../../utils/i18n";
import { translations } from "../../utils/i18n";
import { wordpressClient } from "../../utils/wordpressClient";

export interface Props {
  posts: WordPressPost[];
  lang: Language;
  showHeader?: boolean;
  showYearHeaders?: boolean;
  groupByDate?: boolean;
  layout?: 'card' | 'list';
}

const {
  posts,
  lang,
  showHeader = true,
  showYearHeaders = true,
  groupByDate = true,
  layout = 'card'
} = Astro.props;

const t = translations[lang];

// Agrupar posts por fecha si es necesario
const groupedPosts = groupByDate
  ? wordpressClient.groupPostsByDate(posts)
  : { "all": { "all": posts } };

// Formatear fecha
const formatDate = (dateString: string) => {
  const date = new Date(dateString);
  return date.toLocaleDateString(lang, {
    year: 'numeric',
    month: 'short',
    day: 'numeric'
  });
};

// Formatear mes y año
const formatMonthYear = (year: string, month: string) => {
  return new Date(Number(year), Number(month) - 1).toLocaleDateString(lang, {
    month: 'long',
    year: 'numeric'
  });
};
---

<div class="max-w-4xl mx-auto space-y-8">
  <!-- Header -->
  {showHeader && (
    <div class="text-center mb-12">
      <h1 class="text-4xl md:text-5xl font-light text-onSurface mb-4">
        {t.home}
      </h1>
      <p class="text-xl text-onSurfaceVariant/80 max-w-2xl mx-auto">
        {lang === 'es'
          ? 'Descubre la colección de poemas organizada por tiempo y emoción'
          : 'Discover the poetry collection organized by time and emotion'}
      </p>
    </div>
  )}

  <!-- Estado vacío -->
  {posts.length === 0 && (
    <Card elevated={true} class="text-center">
      <div class="py-20 px-6">
        <div class="i-ph-feather-duotone text-5xl text-primary/60 mb-6 mx-auto"></div>
        <h2 class="text-2xl text-onSurface mb-3">
          {lang === 'es' ? 'Silencio poético' : 'Poetic silence'}
        </h2>
        <p class="text-lg text-onSurfaceVariant/70 mb-4">
          {lang === 'es'
            ? 'Aún no hay poemas para mostrar.'
            : 'No poems to display yet.'}
        </p>
        <div class="i-ph-wind-duotone text-2xl text-outlineVariant/50"></div>
      </div>
    </Card>
  )}

  <!-- Lista de posts -->
  {Object.entries(groupedPosts)
    .sort(([a], [b]) => Number(b) - Number(a))
    .map(([year, months]) => (
      <section class="space-y-8">
        <!-- Encabezado de año -->
        {showYearHeaders && (
          <div class="relative">
            <div class="absolute inset-0 flex items-center">
              <div class="w-full border-t border-outlineVariant/30"></div>
            </div>
            <div class="relative flex justify-center">
              <span class="bg-surface px-4 text-2xl font-medium text-onSurface">
                {year}
              </span>
            </div>
          </div>
        )}

        <!-- Lista de meses o posts -->
        <div class="space-y-6">
          {Object.entries(months)
            .sort(([a], [b]) => Number(b) - Number(a))
            .map(([month, monthPosts]) => (
              <div class="space-y-4">
                <!-- Header del mes -->
                {groupByDate && (
                  <div class="flex items-center gap-4 mb-2">
                    <div class="w-2 h-2 bg-primary rounded-full"></div>
                    <h3 class="text-xl font-medium text-onSurface">
                      {formatMonthYear(year, month)}
                    </h3>
                    <span class="text-sm text-onSurfaceVariant/60">
                      {monthPosts.length} {lang === 'es' ? 'poemas' : 'poems'}
                    </span>
                  </div>
                )}

                <!-- Lista de posts -->
                <div class={layout === 'card' ? 'grid gap-4 md:grid-cols-2' : 'space-y-4'}>
                  {monthPosts.map((post) => {
                    const hasTranslation = post.translations && post.translations.length > 0;
                    const firstTranslation = hasTranslation ? post.translations![0] : null;
                    const translationLang = firstTranslation 
                      ? (firstTranslation.language.code.toLowerCase() as Language)
                      : null;

                    return (
                      <Card 
                        elevated={layout === 'card'} 
                        outlined={layout !== 'card'}
                        class={layout === 'card' ? 'h-full hover:shadow-md transition-shadow' : 'hover:bg-surfaceContainerLow/50'}
                      >
                        <article class={layout === 'card' ? 'p-6 h-full flex flex-col' : 'p-4'}>
                          <!-- Título -->
                          <a
                            href={`/${lang}/${post.slug}/`}
                            class="group block mb-3"
                          >
                            <h3 class={`font-semibold text-onSurface group-hover:text-primary transition-colors ${
                              layout === 'card' ? 'text-xl mb-2' : 'text-lg'
                            }`}>
                              {post.title}
                            </h3>
                          </a>

                          <!-- Metadata -->
                          <div class="flex items-center gap-3 text-sm text-onSurfaceVariant/70 mb-3">
                            <time datetime={post.date}>
                              {formatDate(post.date)}
                            </time>
                            
                            {post.author && (
                              <>
                                <span class="w-1 h-1 bg-outlineVariant/50 rounded-full"></span>
                                <span>{post.author.node.name}</span>
                              </>
                            )}
                          </div>

                          <!-- Extracto -->
                          {post.excerpt && (
                            <p class={`text-onSurfaceVariant mb-4 ${
                              layout === 'card' ? 'text-base line-clamp-3' : 'text-sm line-clamp-2'
                            }`}>
                              {post.excerpt
                                .replace(/<[^>]*>/g, '')
                                .replace(/&nbsp;/g, ' ')
                                .replace(/&amp;/g, '&')
                                .slice(0, layout === 'card' ? 150 : 100)}
                              ...
                            </p>
                          )}

                          <!-- Footer -->
                          <div class="mt-auto flex items-center justify-between gap-3">
                            <!-- Tags -->
                            <div class="flex flex-wrap gap-1">
                              {post.categories?.nodes.slice(0, 2).map((category: any) => (
                                <span class="px-2 py-1 bg-secondaryContainer/50 text-onSecondaryContainer text-xs rounded-full">
                                  {category.name}
                                </span>
                              ))}
                              
                              {hasTranslation && (
                                <span class="px-2 py-1 bg-primary/10 text-primary text-xs rounded-full flex items-center gap-1">
                                  <span class="i-ph-translate text-[0.7rem]"></span>
                                  {translationLang === 'es' ? 'ES' : 'EN'}
                                </span>
                              )}
                            </div>

                            <!-- Acciones -->
                            <div class="flex items-center gap-2">
                              {hasTranslation && firstTranslation && (
                                <a
                                  href={`/${translationLang}/${firstTranslation.slug}/`}
                                  class="text-secondary hover:text-secondary-dark transition-colors text-xs flex items-center gap-1"
                                  title={
                                    lang === 'es'
                                      ? `Versión en ${translationLang === 'es' ? 'español' : 'inglés'}`
                                      : `${translationLang === 'es' ? 'Spanish' : 'English'} version`
                                  }
                                >
                                  <span class="i-ph-arrows-left-right text-[0.7rem]"></span>
                                </a>
                              )}
                              <a
                                href={`/${lang}/${post.slug}/`}
                                class="text-primary hover:text-primary-dark transition-colors text-sm flex items-center gap-1 group/read"
                              >
                                <span class="group-hover/read:underline">
                                  {lang === 'es' ? 'Leer' : 'Read'}
                                </span>
                                <span class="i-ph-arrow-right text-xs transform group-hover/read:translate-x-0.5 transition-transform"></span>
                              </a>
                            </div>
                          </div>
                        </article>
                      </Card>
                    );
                  })}
                </div>
              </div>
            ))}
        </div>
      </section>
    ))}
</div>

<style>
  /* Mejoras visuales */
  .group:hover h3 {
    transform: translateX(2px);
  }
  
  /* Transiciones suaves */
  .transition-all {
    transition: all 0.2s ease;
  }
  
  /* Mejoras de focus */
  a:focus-visible {
    outline: 2px solid var(--color-primary);
    outline-offset: 2px;
    border-radius: 6px;
  }
  
  /* Efectos hover mejorados */
  @media (hover: hover) {
    .hover\:shadow-md:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }
  }
</style>