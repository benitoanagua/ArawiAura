---
import { getCollection } from "astro:content";
import DefaultLayout from "../layouts/DefaultLayout.astro";

export async function getStaticPaths() {
  const poems = await getCollection("poems", (p) => !p.data.draft);

  return poems.map((poem) => ({
    params: {
      // Para rutas catch-all, necesitamos pasar el slug como string unido
      slug: poem.slug, // "en/2025/07/river-of-memories"
    },
    props: { poem },
  }));
}

// Extraer el slug de los parámetros
const { slug } = Astro.params;
const { poem } = Astro.props;

// Verificar que tenemos el poema
if (!poem) {
  throw new Error(`Poem not found for slug: ${slug}`);
}

const { Content } = await poem.render();

// Extraer el idioma del slug
const langFromSlug = poem.slug.split("/")[0];
---

<DefaultLayout lang={langFromSlug}>
  <article class="prose mx-auto">
    <h1>{poem.data.title}</h1>
    <time datetime={poem.data.date.toISOString()}>
      {
        poem.data.date.toLocaleDateString(poem.data.lang, {
          year: "numeric",
          month: "long",
          day: "numeric",
        })
      }
    </time>

    <Content />

    {
      poem.data.translation && (
        <footer class="mt-12 pt-4 border-t">
          <p>
            {poem.data.lang === "es"
              ? "También disponible en inglés:"
              : "Also available in Spanish:"}{" "}
            <a href={`/${poem.data.translation}/`}>
              {poem.data.lang === "es" ? "Read translation" : "Leer traducción"}
            </a>
          </p>
        </footer>
      )
    }
  </article>
</DefaultLayout>
