---
import MainLayout from "../../layouts/MainLayout.astro";
import Card from "../../components/ui/Card.astro";
import type { Language } from "../../utils/i18n";
import { translations } from "../../utils/i18n";
import { wordpressClient } from "../../utils/wordpressClient";

export async function getStaticPaths() {
  return [{ params: { lang: "es" } }, { params: { lang: "en" } }];
}

const { lang } = Astro.params;
const validLang: Language = lang === "es" || lang === "en" ? lang : "en";
const t = translations[validLang];

// Get statistics for the archive
let stats = {
  totalPosts: 0,
  years: [] as string[],
  categories: [] as string[],
  languages: [] as string[],
};

try {
  const allPostsResult = await wordpressClient.getPosts(1000);
  const allPosts = allPostsResult.posts;

  // Filter posts by language
  const langPosts = wordpressClient.filterPostsByLanguage(allPosts, validLang);

  stats.totalPosts = langPosts.length;

  // Get unique years
  stats.years = [
    ...new Set(
      langPosts.map((post) => new Date(post.date).getFullYear().toString())
    ),
  ]
    .sort()
    .reverse();

  // Get unique categories
  stats.categories = [
    ...new Set(
      langPosts.flatMap(
        (post) => post.categories?.nodes.map((cat) => cat.name) || []
      )
    ),
  ].sort();

  // Get available languages
  const availableLanguages = await wordpressClient.getAvailableLanguages();
  stats.languages = availableLanguages.map((l) => l.name);
} catch (error) {
  console.error("Error fetching archive data:", error);
}

const pageTitle = t.archive;
const pageDescription =
  validLang === "es"
    ? "Archivo completo de poemas Arawi Aura organizados por año y mes. Explora la colección completa."
    : "Complete archive of Arawi Aura poems organized by year and month. Explore the full collection.";
---

<MainLayout
  title={pageTitle}
  description={pageDescription}
  lang={validLang}
  canonicalPath={`/${validLang}/archive/`}
>
  <div class="space-y-8">
    <!-- Archive Header -->
    <Card elevated class="text-center">
      <h1 class="text-3xl font-bold text-onSurface mb-4">{pageTitle}</h1>
      <p class="text-onSurfaceVariant mb-6">
        {
          validLang === "es"
            ? "Explora todos los poemas organizados cronológicamente"
            : "Browse all poems organized chronologically"
        }
      </p>

      <!-- Archive Statistics -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
        <div class="bg-primaryContainer/20 rounded-lg p-4">
          <div class="text-2xl font-bold text-primary">{stats.totalPosts}</div>
          <div class="text-sm text-onSurfaceVariant">
            {validLang === "es" ? "Poemas" : "Poems"}
          </div>
        </div>
        <div class="bg-secondaryContainer/20 rounded-lg p-4">
          <div class="text-2xl font-bold text-secondary">
            {stats.years.length}
          </div>
          <div class="text-sm text-onSurfaceVariant">
            {validLang === "es" ? "Años" : "Years"}
          </div>
        </div>
        <div class="bg-tertiaryContainer/20 rounded-lg p-4">
          <div class="text-2xl font-bold text-tertiary">
            {stats.categories.length}
          </div>
          <div class="text-sm text-onSurfaceVariant">
            {validLang === "es" ? "Categorías" : "Categories"}
          </div>
        </div>
        <div class="bg-surfaceVariant/20 rounded-lg p-4">
          <div class="text-2xl font-bold text-onSurfaceVariant">
            {stats.languages.length}
          </div>
          <div class="text-sm text-onSurfaceVariant">
            {validLang === "es" ? "Idiomas" : "Languages"}
          </div>
        </div>
      </div>
    </Card>

    <!-- Navigation Instructions -->
    <Card>
      <h2 class="text-xl font-semibold text-onSurface mb-4">
        {
          validLang === "es"
            ? "Cómo navegar el archivo"
            : "How to navigate the archive"
        }
      </h2>

      <div class="grid md:grid-cols-2 gap-6">
        <div>
          <h3 class="font-medium text-onSurface mb-2">
            {validLang === "es" ? "Explorar por tiempo" : "Browse by time"}
          </h3>
          <ul class="text-sm text-onSurfaceVariant space-y-1">
            <li>
              • <a href={`/${validLang}/`} class="text-primary hover:underline">
                {validLang === "es" ? "Vista principal" : "Main view"}
              </a> - {
                validLang === "es"
                  ? "Organizado por año y mes"
                  : "Organized by year and month"
              }
            </li>
            <li>
              • {
                validLang === "es"
                  ? "Los más recientes aparecen primero"
                  : "Most recent posts appear first"
              }
            </li>
          </ul>
        </div>

        <div>
          <h3 class="font-medium text-onSurface mb-2">
            {validLang === "es" ? "Buscar contenido" : "Search content"}
          </h3>
          <ul class="text-sm text-onSurfaceVariant space-y-1">
            <li>
              • {
                validLang === "es"
                  ? "Usa el buscador (esquina inferior derecha)"
                  : "Use the search button (bottom right corner)"
              }
            </li>
            <li>
              • {
                validLang === "es"
                  ? "Busca por título, contenido o categorías"
                  : "Search by title, content, or categories"
              }
            </li>
            <li>
              • {
                validLang === "es"
                  ? "Atajo de teclado: Ctrl+K"
                  : "Keyboard shortcut: Ctrl+K"
              }
            </li>
          </ul>
        </div>
      </div>
    </Card>

    <!-- Years Overview -->
    {
      stats.years.length > 0 && (
        <Card>
          <h2 class="text-xl font-semibold text-onSurface mb-4">
            {validLang === "es" ? "Años disponibles" : "Available years"}
          </h2>
          <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3">
            {stats.years.map((year) => (
              <a
                href={`/${validLang}/#${year}`}
                class="bg-surfaceContainer hover:bg-surfaceContainerHighest text-center p-3 rounded-lg transition-colors group"
                key={year}
              >
                <div class="text-lg font-semibold text-onSurface group-hover:text-primary">
                  {year}
                </div>
              </a>
            ))}
          </div>
        </Card>
      )
    }

    <!-- Categories Overview -->
    {
      stats.categories.length > 0 && (
        <Card>
          <h2 class="text-xl font-semibold text-onSurface mb-4">
            {validLang === "es" ? "Categorías" : "Categories"}
          </h2>
          <div class="flex flex-wrap gap-2">
            {stats.categories.map((category) => (
              <span
                class="px-3 py-1 bg-secondaryContainer/30 text-onSecondaryContainer rounded-full text-sm cursor-default"
                key={category}
              >
                {category}
              </span>
            ))}
          </div>
          <p class="text-xs text-onSurfaceVariant mt-3">
            {validLang === "es"
              ? "Usa el buscador para filtrar por categoría específica"
              : "Use the search function to filter by specific category"}
          </p>
        </Card>
      )
    }

    <!-- Quote -->
    <Card class="text-center bg-primaryContainer/10">
      <blockquote class="text-lg italic text-onSurface mb-2">
        {
          validLang === "es"
            ? '"Escribimos para saborear la vida dos veces."'
            : '"We write to taste life twice."'
        }
      </blockquote>
      <cite class="text-onSurfaceVariant">—Anaïs Nin</cite>
    </Card>
  </div>
</MainLayout>
